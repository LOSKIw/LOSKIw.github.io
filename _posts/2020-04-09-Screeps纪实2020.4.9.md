---
layout:     post                    # 使用的布局（不需要改）
title:      Screeps纪实-2020/04/09               # 标题 
subtitle:   完成初步任务系统调试完毕 #副标题
date:       2020-04-09             # 时间
author:     LOSKI                      # 作者
header-img: img/bg-screeps-world-200320.png    #这篇文章标题背景图片
catalog: true                       # 是否归档
tags:                               #标签
    - Screeps
---

Screeps纪实-2020/04/09

# 任务系统完成啦!
经历了在私服上的调试以及官府上近一周的运行，目前来看我的任务系统重构已经是初步成功了。  
目前房内物流，跨房能量平衡，spawn生产队列已简单实现。  
最初的构想中计划是将任务悬挂在任务中枢上，不分配到特定creep，但是不知道为什么无法正常运行，最终还是做成了任务队列，把每个任务交予特定的creep，虽然失去了多人同时完一个任务的能力，但最终也由此正常运行了。  
  
我的实现，比较简单粗暴，任务系统整体可以分为两个部分  
### 一是任务发布者 ###
任务发布者包括了一切在我代码中有发布任务能力的建筑，单位，或是抽象的决策脚本。各举例子的话，建筑如Tower，单位如transferer、center，抽象脚本如跨放平衡系统及物资分配系统(未实现)。其中，建筑以及抽象脚本是主要，creep的任务发布大多为附属，如center接收到售卖任务后，会将特定矿物搬运至Terminal，在完成后自动挂出Order，该Order便是center被分配的附属发布任务。  
而建筑以及脚本，为了避免重复发布任务，均用变量记录该建筑是否有发出任务。虽然意味着更大的内存消耗，但是比较简单，且memory充足的情况中，以此换取cpu不失为一好方法。  
建筑的任务目前仅实现了部分，已Tower低容量填充，Storage原矿自动挂单为主，而energy填充方面则由抽象脚本负责(毕竟也就是个判断的事情),其中，Tower由于仍是只是用了一变量标记任务是否发布，因此一时间只能有一个Tower填充任务被发布，是一个隐患，后期需要更多的优化。  
其中Storage与Terminal目前比较特殊，因为直接与跨房物流，市场相关，所以设置的可能稍有不同，到后面可能会进行一部分的统一。  
### 二是任务执行者 ###
目前的任务接受/执行者只有spawn，center，transferer。
#### spawn ####
Spawn目前在Rcl6时由于房间Extension容量较少，仍有宕机风险，最终可能仍旧需要手动重启，这也是比较迷得地方，改完代码后反而失去了重启的功能，不过一般死不了就是了。  
> 这里说一下目前的一个问题，由于Energy填充我一开始一位spawn的自动产能会导致任务数目的不匹配，所以房价内建造creeps目前一律不使用spawn，但是后来才注意到spawn只有在房间总能量小于300时会自产，可能因此会导致一些浪费，以及生产时遍历extension的算力浪费，还有memory存储extension的id浪费等等，不过目前来看...应该可以忽略?(大概吧  
  
并且除了每次重推代码以及500ticks一次的检查，spawn队列的维护不会像之前一样每ticks检查房间内creeps数目。房间内常驻工作单位阵亡或者临死时会将同类工作creep的生产任务推入spawn生产队列中，既减少了cpu消耗，也拥有了提前量生产的效果(不过提前量写死了20ticks看起来比较暴力/小声
####Transferer/Center####
至于transferer以及center，相差不多，且都有自己的任务队列。  
一开始我的代码不怎么严密，他俩都有一个隐藏bug，就是在执行某些任务的过程中，如果死了，会导致比较严重的后果。如果center在转运中央Link能量的话，会导致任务数额不匹配，transferer在转运mineral的话，会重新去字母矿那里等待同样数目的mineral产出从而导致房间宕机，因此，我手动设定了一些阈值，即在该creep的tickstolive小于某值后便不再接受特定任务，其中transferer的能量填充我没改，而字母矿的阈值设置比较大，保证一趟的来回，并且设置了个粗略的优先级，即每次交付物资时会查看房间任务的发布情况，如果有更重要的就将当前任务入队，并获得重要任务  
    `Transferer:Energy填充>Tower填充>其它`  
    `Center:中央Link转移>其它`  
不得不说，看似简单粗暴的改动，真就可以说是一劳永逸的解决了许多问题。  
  
接着大概概括一下最近动向?  
目前有了三个8房，且正在准备获取第七房，获取方式目前来看应该能通过我的第一颗Nuker获得，除非有意外，且到手后我的原矿全齐，可以开始准备自给自足的Lab产业(或者说究极懒惰的原矿商人?  
目前来看，下一步是PB采集，deposit附近实在太少不想管了，同时可以考虑构思一下怎么实现自动采集，目前我的领地十分集中，冲突的可能比较小。  
BILIBILI...?咕了咕了/跑  
  
```
>todo_list
['Pb_mining','Lab','作战代码:['一体机','两人小队']']
```  
LOSKI/从心怂车车 2020/04/09  